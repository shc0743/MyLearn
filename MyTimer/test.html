<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç²¾åº¦è®¡æ—¶å™¨ WASM æ¼”ç¤º</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button { 
            margin: 5px; 
            padding: 10px 15px; 
            background: #007acc; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        button:hover { background: #005a9e; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            background: #e8f4fd; 
            border-radius: 4px; 
            border-left: 4px solid #007acc;
        }
        .comparison { 
            display: flex; 
            justify-content: space-between; 
            margin: 20px 0;
        }
        .comparison > div { 
            flex: 1; 
            margin: 0 10px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px;
        }
        code { 
            background: #f4f4f4; 
            padding: 2px 4px; 
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ•’ é«˜ç²¾åº¦è®¡æ—¶å™¨ WASM æ¼”ç¤º</h1>
        <p>ä½¿ç”¨ C++ chrono åº“å®ç°çš„çº³ç§’çº§ç²¾åº¦è®¡æ—¶å™¨</p>
        
        <div class="comparison">
            <div>
                <h3>WASM é«˜ç²¾åº¦è®¡æ—¶å™¨</h3>
                <button onclick="getWasmNanoseconds()">è·å–çº³ç§’æ—¶é—´æˆ³</button>
                <button onclick="startWasmTimer()">å¯åŠ¨è®¡æ—¶å™¨</button>
                <button onclick="stopWasmTimer()" id="stopWasmBtn" disabled>åœæ­¢è®¡æ—¶å™¨</button>
                <button onclick="runPerformanceTest()">æ€§èƒ½æµ‹è¯• (Fibonacci 35)</button>
                <div id="wasmResults"></div>
            </div>
            
            <div>
                <h3>JavaScript åŸç”Ÿè®¡æ—¶å™¨</h3>
                <button onclick="getJSNanoseconds()">è·å–çº³ç§’æ—¶é—´æˆ³</button>
                <button onclick="startJSTimer()">å¯åŠ¨è®¡æ—¶å™¨</button>
                <button onclick="stopJSTimer()" id="stopJSBtn" disabled>åœæ­¢è®¡æ—¶å™¨</button>
                <button onclick="runJSPerformanceTest()">æ€§èƒ½æµ‹è¯• (Fibonacci 35)</button>
                <div id="jsResults"></div>
            </div>
        </div>

        <div>
            <h3>å®æ—¶æ—¶é—´æˆ³ç›‘æ§</h3>
            <button onclick="startRealtimeMonitor()">å¯åŠ¨å®æ—¶ç›‘æ§</button>
            <button onclick="stopRealtimeMonitor()">åœæ­¢å®æ—¶ç›‘æ§</button>
            <div id="realtimeResults" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; margin-top: 10px;"></div>
        </div>
    </div>

    <script src="timer.js"></script>

<script>
    let wasmModule;
    let wasmTimerHandle = null;
    let jsTimerStart = null;
    let realtimeInterval = null;

    // åˆå§‹åŒ– WASM æ¨¡å—
    async function initializeWasm() {
        try {
            wasmModule = await timer();
            console.log('WASM æ¨¡å—åŠ è½½æˆåŠŸ');
            
            // æµ‹è¯•å‡½æ•°æ˜¯å¦æ­£å¸¸
            const testNs = wasmModule._get_nanoseconds_since_epoch();
            console.log('æµ‹è¯•æ—¶é—´æˆ³:', testNs, typeof testNs);
            
        } catch (error) {
            console.error('WASM æ¨¡å—åŠ è½½å¤±è´¥:', error);
            document.getElementById('wasmResults').innerHTML = 
                '<div class="result" style="color: red;">WASM æ¨¡å—åŠ è½½å¤±è´¥: ' + error.message + '</div>';
        }
    }

    // WASM å‡½æ•°åŒ…è£… - æ­£ç¡®å¤„ç† BigInt
    function getNanoseconds() {
        const result = wasmModule._get_nanoseconds_since_epoch();
        return typeof result === 'bigint' ? result : BigInt(result);
    }

    function getMicroseconds() {
        const result = wasmModule._get_microseconds_since_epoch();
        return typeof result === 'bigint' ? result : BigInt(result);
    }

    function getMilliseconds() {
        const result = wasmModule._get_milliseconds_since_epoch();
        return typeof result === 'bigint' ? result : BigInt(result);
    }

    function createTimer() {
        const result = wasmModule._create_timer();
        return typeof result === 'bigint' ? result : BigInt(result);
    }

    function getElapsedNanoseconds(handle) {
        const result = wasmModule._get_elapsed_nanoseconds(handle);
        return typeof result === 'bigint' ? result : BigInt(result);
    }

    function destroyTimer(handle) {
        wasmModule._destroy_timer(handle);
    }

    function fibonacciTest(n) {
        const result = wasmModule._fibonacci_test(n);
        return typeof result === 'bigint' ? result : BigInt(result);
    }

    // WASM æ“ä½œå‡½æ•° - æ­£ç¡®å¤„ç† BigInt æ˜¾ç¤º
    function getWasmNanoseconds() {
        try {
            const ns = getNanoseconds();
            // å°† BigInt è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ˜¾ç¤ºï¼Œé¿å…æ•°å€¼è¿ç®—
            document.getElementById('wasmResults').innerHTML = 
                `<div class="result">
                    <strong>çº³ç§’æ—¶é—´æˆ³:</strong><br>
                    ${ns.toString()} ns<br>
                    <small>${(Number(ns) / 1e9).toFixed(9)} ç§’</small>
                </div>`;
        } catch (error) {
            document.getElementById('wasmResults').innerHTML = 
                '<div class="result" style="color: red;">é”™è¯¯: ' + error.message + '</div>';
        }
    }

    function startWasmTimer() {
        try {
            wasmTimerHandle = createTimer();
            document.getElementById('stopWasmBtn').disabled = false;
            document.getElementById('wasmResults').innerHTML = 
                '<div class="result">è®¡æ—¶å™¨å·²å¯åŠ¨...</div>';
        } catch (error) {
            document.getElementById('wasmResults').innerHTML = 
                '<div class="result" style="color: red;">å¯åŠ¨è®¡æ—¶å™¨å¤±è´¥: ' + error.message + '</div>';
        }
    }

    function stopWasmTimer() {
        if (wasmTimerHandle !== null) {
            try {
                const elapsed = getElapsedNanoseconds(wasmTimerHandle);
                destroyTimer(wasmTimerHandle);
                wasmTimerHandle = null;
                document.getElementById('stopWasmBtn').disabled = true;
                document.getElementById('wasmResults').innerHTML = 
                    `<div class="result">
                        <strong>ç»è¿‡æ—¶é—´:</strong><br>
                        ${elapsed.toString()} ns<br>
                        <small>${(Number(elapsed) / 1e6).toFixed(6)} æ¯«ç§’</small>
                    </div>`;
            } catch (error) {
                document.getElementById('wasmResults').innerHTML = 
                    '<div class="result" style="color: red;">åœæ­¢è®¡æ—¶å™¨å¤±è´¥: ' + error.message + '</div>';
            }
        }
    }

    function runPerformanceTest() {
        document.getElementById('wasmResults').innerHTML = 
            '<div class="result">è®¡ç®—ä¸­... (Fibonacci 35)</div>';
        
        setTimeout(() => {
            try {
                const elapsed = fibonacciTest(35);
                document.getElementById('wasmResults').innerHTML = 
                    `<div class="result">
                        <strong>æ€§èƒ½æµ‹è¯•ç»“æœ:</strong><br>
                        Fibonacci(35) è®¡ç®—è€—æ—¶:<br>
                        ${elapsed.toString()} ns<br>
                        <small>${(Number(elapsed) / 1e6).toFixed(3)} æ¯«ç§’</small>
                    </div>`;
            } catch (error) {
                document.getElementById('wasmResults').innerHTML = 
                    '<div class="result" style="color: red;">æ€§èƒ½æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }, 100);
    }

    // JavaScript åŸç”Ÿå®ç°
    function getJSNanoseconds() {
        // ä½¿ç”¨ BigInt é¿å…æ•°å€¼ç²¾åº¦é—®é¢˜
        const ns = BigInt(Math.floor(performance.now() * 1e6));
        document.getElementById('jsResults').innerHTML = 
            `<div class="result">
                <strong>çº³ç§’æ—¶é—´æˆ³:</strong><br>
                ${ns.toString()} ns<br>
                <small>${(Number(ns) / 1e9).toFixed(9)} ç§’</small>
            </div>`;
    }

    function startJSTimer() {
        jsTimerStart = performance.now();
        document.getElementById('stopJSBtn').disabled = false;
        document.getElementById('jsResults').innerHTML = 
            '<div class="result">è®¡æ—¶å™¨å·²å¯åŠ¨...</div>';
    }

    function stopJSTimer() {
        if (jsTimerStart !== null) {
            const elapsed = (performance.now() - jsTimerStart) * 1e6;
            jsTimerStart = null;
            document.getElementById('stopJSBtn').disabled = true;
            document.getElementById('jsResults').innerHTML = 
                `<div class="result">
                    <strong>ç»è¿‡æ—¶é—´:</strong><br>
                    ${Math.floor(elapsed)} ns<br>
                    <small>${(elapsed / 1e6).toFixed(6)} æ¯«ç§’</small>
                </div>`;
        }
    }

    function runJSPerformanceTest() {
        document.getElementById('jsResults').innerHTML = 
            '<div class="result">è®¡ç®—ä¸­... (Fibonacci 35)</div>';
        
        setTimeout(() => {
            const start = performance.now();
            
            function fib(n) {
                if (n <= 1) return n;
                return fib(n - 1) + fib(n - 2);
            }
            
            fib(35);
            const elapsed = (performance.now() - start) * 1e6;
            
            document.getElementById('jsResults').innerHTML = 
                `<div class="result">
                    <strong>æ€§èƒ½æµ‹è¯•ç»“æœ:</strong><br>
                    Fibonacci(35) è®¡ç®—è€—æ—¶:<br>
                    ${Math.floor(elapsed)} ns<br>
                    <small>${(elapsed / 1e6).toFixed(3)} æ¯«ç§’</small>
                </div>`;
        }, 100);
    }

    // å®æ—¶ç›‘æ§ - æ­£ç¡®å¤„ç† BigInt æ¯”è¾ƒ
    function startRealtimeMonitor() {
        stopRealtimeMonitor();
        const resultsDiv = document.getElementById('realtimeResults');
        resultsDiv.innerHTML = '<div>å¯åŠ¨å®æ—¶ç›‘æ§...</div>';
        
        let count = 0;
        realtimeInterval = setInterval(() => {
            try {
                const wasmTime = getNanoseconds();
                const jsTime = BigInt(Math.floor(performance.now() * 1e6));
                // BigInt å¯ä»¥ç›´æ¥ç›¸å‡
                const difference = wasmTime - jsTime;
                
                count++;
                resultsDiv.innerHTML = 
                    `<div>[${count}] WASM: ${wasmTime.toString()} ns | JS: ${jsTime.toString()} ns | å·®å€¼: ${difference.toString()} ns</div>` + 
                    resultsDiv.innerHTML;
                
                if (count > 50) {
                    resultsDiv.innerHTML = resultsDiv.innerHTML.split('<div>').slice(0, 51).join('<div>');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: red;">ç›‘æ§é”™è¯¯: ${error.message}</div>`;
                stopRealtimeMonitor();
            }
        }, 100);
    }

    function stopRealtimeMonitor() {
        if (realtimeInterval) {
            clearInterval(realtimeInterval);
            realtimeInterval = null;
        }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    initializeWasm();
</script>

</body>
</html>